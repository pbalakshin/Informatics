
% !TeX root = ../../main.tex
\subsubsection{Код Хаффмана}\label{subsubsec:huffman-code}

\begin{wrapfigure}{l}{0.25\textwidth}
    \centering
    \vspace{-\intextsep}
    \includegraphics[width=0.25\textwidth]{person/huffman-david}
    \caption*{Дэвид Хаффман\\1925 -- 1999}
\end{wrapfigure}

Код (алгоритм) Хаффмана был разработан в 1952 году аспирантом Массачусетского технологического института Дэвидом Хаффманом при написании им курсовой работы.

Как и алгоритм Шеннона-Фано, основан на частоте повторения. Зная вероятности символов в сообщении, можно описать процедуру построения кодов переменной длины, состоящих из целого количества битов. Символам с большей вероятностью ставятся в соответствие более короткие коды. Коды Хаффмана обладают свойством префиксности, что позволяет однозначно их декодировать.

Однако, в отличие от кодов Шеннона-Фано, коды Хаффмана всегда являются оптимальными.

Сжатие данных по Хаффману применяется при сжатии фото- и видеоизображений (JPEG, стандарты сжатия MPEG), в архиваторах (PKZIP, LZH), в протоколах передачи данных MNP5 и MNP7.

\paragraph{Алгоритм Хаффмана для неоптимальных префиксных кодов}\label{par:huffman-algo-non-optimal}

\begin{enumerate}
    \item Символы входного алфавита образуют список свободных узлов. Каждый узел имеет вес, равный вероятности появления символа в сжимаемом тексте (исходной последовательности). Строится дерево от листьев (узлов) к корню:
    \item Выбираются два свободных узла дерева с наименьшими весами;
    \item Создается их родитель с весом, равным их суммарному весу;
    \item Родитель добавляется в список свободных узлов, а двое его детей удаляются из этого списка.
    \item Одной дуге, выходящей из родителя (узлу с большим весом), ставится в соответствие значение $1$, а другой (узлу с меньшим весом) значение $0$.
    \item Повторяем шаги 2-4, выбирая в качестве одного из свободных узлов родителя, до тех пор, пока в списке свободных узлов не останется только один свободный узел. Он и будет считаться корнем дерева.
    \item Символ входного (первичного) алфавита кодируется последовательностью нулей и единиц в соответствии с распределением их от корня дерева к узлам (листьям).
\end{enumerate}

\example{1}
\task{} составить код Хаффмана для неоптимальных префиксных кодов для последовательности AAABCCCCCDEEEF. Найти среднюю длину кодового слова.
\solution{} составим список свободных узлов для исходной последовательности:
\begin{table}[H]
    \centering
    \begin{tabular}{|r|c|c|c|c|c|c|}
    \hline
    \textbf{Символ} & A & B & C & D & E & F \\ \hline
    \textbf{Вероятность} & $\sfrac{3}{14}$ & $\sfrac{1}{14}$ & $\sfrac{5}{14}$ & $\sfrac{1}{14}$ & $\sfrac{3}{14}$ & $\sfrac{1}{14}$ \\ \hline
    \end{tabular}
\end{table}
% \begin{itemize}
%     \item Символ $A$ с вероятностью $\sfrac{3}{14}$;
%     \item Символ $B$ с вероятностью $\sfrac{1}{14}$;
%     \item Символ $C$ с вероятностью $\sfrac{5}{14}$;
%     \item Символ $D$ с вероятностью $\sfrac{1}{14}$;
%     \item Символ $E$ с вероятностью $\sfrac{3}{14}$;
%     \item Символ $F$ с вероятностью $\sfrac{1}{14}$;
% \end{itemize}

\noindent
Построим кодовое дерево:

\begin{table}[H]
    \centering
    \begin{tabular}{c c c c c c}
        \multicolumn{6}{l}{DBFAEC ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{3}{14} + \sfrac{3}{14} + \sfrac{5}{14}$)} \\
        $\swarrow$ & \multicolumn{4}{c}{$\searrow$} & \\
        C ($\sfrac{5}{14}$) & \multicolumn{5}{l}{DBFAE ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{3}{14} + \sfrac{3}{14}$)} \\
        & $\swarrow$ & \multicolumn{3}{c}{$\searrow$} & \\
        & E ($\sfrac{3}{14}$) & \multicolumn{4}{l}{DBFA ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{3}{14}$)} \\
        & & $\swarrow$ & \multicolumn{2}{c}{$\searrow$} & \\
        & & A ($\sfrac{3}{14}$) & \multicolumn{3}{l}{DBF ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14}$)} \\
        & & & $\swarrow$ & $\searrow$ & \\
        & & & F ($\sfrac{1}{14}$) & \multicolumn{2}{c}{DB ($\sfrac{1}{14} + \sfrac{1}{14}$)} \\
        & & & & $\swarrow$ & $\searrow$ \\
        & & & & B ($\sfrac{1}{14}$) & D ($\sfrac{1}{14}$) \\
    \end{tabular}
\end{table}

\noindentОдной дуге, выходящей из родителя (узлу с большим весом), присвоим значение $1$, а другой (узлу с меньшим весом) - значение $0$.

\begin{table}[H]
    \centering
    \begin{tabular}{c c c c c c}
    \multicolumn{6}{l}{DBFAEC ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{3}{14} + \sfrac{3}{14} + \sfrac{5}{14}$)} \\
    \textbf{[0]} $\swarrow$ & \multicolumn{4}{c}{$\searrow$ \textbf{[1]}} & \\
    C ($\sfrac{5}{14}$) & \multicolumn{5}{l}{DBFAE ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{3}{14} + \sfrac{3}{14}$)} \\
    & \textbf{[0]} $\swarrow$ & \multicolumn{3}{c}{$\searrow$ \textbf{[1]}} & \\
    & E ($\sfrac{3}{14}$) & \multicolumn{4}{l}{DBFA ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{3}{14}$)} \\
    & & \textbf{[0]} $\swarrow$ & \multicolumn{2}{c}{$\searrow$ \textbf{[1]}} & \\
    & & A ($\sfrac{3}{14}$) & \multicolumn{3}{l}{DBF ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14}$)} \\
    & & & \textbf{[0]} $\swarrow$ & $\searrow$ \textbf{[1]} & \\
    & & & F ($\sfrac{1}{14}$) & \multicolumn{2}{c}{DB ($\sfrac{1}{14} + \sfrac{1}{14}$)} \\
    & & & & \textbf{[0]} $\swarrow$ & $\searrow$  \textbf{[1]} \\
    & & & & B ($\sfrac{1}{14}$) & D ($\sfrac{1}{14}$) \\
    \end{tabular}
\end{table}

\noindent
Получим следующую таблицу для кодировки:

\begin{table}[H]
    \centering
    \begin{tabular}{|r|c|c|c|c|c|c|}
    \hline
    \textbf{Символ} & A & B & C & D & E & F \\ \hline
    \textbf{Код} & 110 & 11110 & 0 & 11111 & 10 & 1110 \\ \hline
    \end{tabular}
\end{table}

\noindent
Исходная последовательность AAABCCCCCDEEEF кодируется следующей: $110.110.110.11110.0.0.0.0.0.11111.10.10.10.1110$ --- 34 бита.

\noindent
Средняя длина кодового слова:
\[
    1 \times \frac{5}{14} + 2 \times \frac{3}{14} + 3 \times \frac{3}{14} + 4 \times \frac{1}{14} + 5 \times \frac{1}{14} + 5 \times \frac{1}{14} = \frac{34}{14} \approx 2,4
\]

\paragraph{Алгоритм Хаффмана для оптимальных префиксных кодов}\label{par:huffman-algo-optimal}

\begin{enumerate}
    \item Символы входного (первичного) алфавита выписывают по убыванию вероятностей (весов) в таблицу.
    \item Выбираются два свободных узла (элемента) с наименьшими весами (вероятностями);
    \item Верхнему узлу (с большим весом) присваивается значение $1$, а нижнему (с меньшим весом) --- $0$;
    \item Создается их родитель с весом, равным их суммарному весу;
    \item Родитель добавляется в список свободных узлов (таблицу), занимая соответствующее место в списке убывающих во величине весов (вероятностей), а двое его детей удаляются из этого списка.
    \item Повторяем шаги 2--5, до тех пор, пока в списке свободных узлов (в таблице) не останется только два свободных узла (элемента).
    \item Символ входного (первичного) алфавита кодируется последовательностью нулей и единиц в соответствии с распределением их от корня к узлам.
\end{enumerate}

\example{2}
\task{} составить код Хаффмана для неоптимальных префиксных кодов для последовательности AAABCCCCCDEEEF. Найти среднюю длину кодового слова.
\solution{} составим список свободных узлов для исходной последовательности:
\begin{table}[H]
    \centering
    \begin{tabular}{|r|c|c|c|c|c|c|}
        \hline
        \textbf{Символ} & C & A & E & B & D & F \\\hline
        \textbf{Вероятность, $p$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$ & $\sfrac{3}{14}$ & $\sfrac{1}{14}$ & $\sfrac{1}{14}$ & $\sfrac{1}{14}$ \\\hline
    \end{tabular}
\end{table}

\noindent
Построим таблицу

\begin{table}[H]
    \centering
    \begin{tabular}{|l|c||l|c||l|c||l|c||l|c|}
        \hhline{--||--||--||--||--}
        C & $\sfrac{5}{14}$ & C & $\sfrac{5}{14}$ & C & $\sfrac{5}{14}$ & EDFB & $\sfrac{6}{14}$ & CA & $\sfrac{8}{14}$ \\
        A & $\sfrac{3}{14}$ & A & $\sfrac{3}{14}$ & A & $\sfrac{3}{14}$ & C & $\sfrac{5}{14}$ & EDFB & $\sfrac{6}{14}$ \\
        E & $\sfrac{3}{14}$ & E & $\sfrac{3}{14}$ & E & $\sfrac{3}{14}$ & A & $\sfrac{3}{14}$ & & \\
        B & $\sfrac{1}{14}$ & DF & $\sfrac{2}{14}$ & DFB & $\sfrac{3}{14}$ & & & &\\
        D & $\sfrac{1}{14}$ & B & $\sfrac{1}{14}$ & & & & & &\\
        F & $\sfrac{1}{14}$ & & & & & & & &\\
        \hhline{--||--||--||--||--}
    \end{tabular}
\end{table}


\begin{table}[H]
    \centering
    \resizebox{\textwidth}{!}{
        % \renewcommand{\arraystretch}{1.5}
        \begin{tabular}{|r|c|>{\bfseries}c||r|c|>{\bfseries}c||r|c|>{\bfseries}c||r|c|>{\bfseries}c||r|c|>{\bfseries}c|}
            \hhline{---||---||---||---||---}
            C & $^{5}/_{14}$ &     & C  & $\sfrac{5}{14}$ &     & C   & $\sfrac{5}{14}$ &     & EDFB & $\sfrac{6}{14}$ &     & CA   & $\sfrac{8}{14}$ & [1] \\
            A & $^{3}/_{14}$ &     & A  & $\sfrac{3}{14}$ &     & A   & $\sfrac{3}{14}$ &     & C    & $\sfrac{5}{14}$ & [1] & EDFB & $\sfrac{6}{14}$ & [0] \\
            E & $^{3}/_{14}$ &     & E  & $\sfrac{3}{14}$ &     & E   & $\sfrac{3}{14}$ & [1] & A    & $\sfrac{3}{14}$ & [0] &      &            &     \\
            B & $^{1}/_{14}$ &     & DF & $\sfrac{2}{14}$ & [1] & DFB & $\sfrac{3}{14}$ & [0] &      &            &     &      &            &     \\
            D & $^{1}/_{14}$ & [1] & B  & $\sfrac{1}{14}$ & [0] &     &            &     &      &            &     &      &            &     \\
            F & $^{1}/_{14}$ & [0] &    &            &     &     &            &     &      &            &     &      &            &     \\
            \hhline{---||---||---||---||---}
        \end{tabular}}
\end{table}

% \begin{table}[H]
% \begin{tabular}{|r|c|c|c|c|c|c|}
% \hline
% \textbf{Символ} & C & A & E & B & D & F \\ \hline
% \textbf{Вероятность, $p$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$ & $\sfrac{3}{14}$ & $\sfrac{1}{14}$ & $\sfrac{1}{14}$ & $\sfrac{1}{14}$ \\ \hline\hline

% \textbf{Символ} & C & A & E & \multicolumn{2}{c|}{DF} & B \\ \hline
% \textbf{Вероятность, $p$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$ & $\sfrac{3}{14}$  & \multicolumn{2}{c|}{$\sfrac{2}{14}$} & $\sfrac{1}{14}$ \\ \hline\hline

% \textbf{Символ} & C & A & E & \multicolumn{3}{c|}{DFB} \\ \hline
% \textbf{Вероятность, $p$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$ & $\sfrac{3}{14}$  & \multicolumn{3}{c|}{$\sfrac{3}{14}$} \\ \hline\hline

% \textbf{Символ} & \multicolumn{4}{c|}{EDFB} & C & A \\ \hline
% \textbf{Вероятность, $p$} & \multicolumn{4}{c|}{$\sfrac{6}{14}$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$  \\ \hline\hline

% \textbf{Символ} & \multicolumn{2}{c|}{CA} & \multicolumn{4}{c|}{EDFB} \\ \hline
% \textbf{Вероятность, $p$} & \multicolumn{2}{c|}{$\sfrac{8}{14}$} & \multicolumn{4}{c|}{$\sfrac{6}{14}$} \\ \hline
% \end{tabular}
% \end{table}

\noindentВерхнему узлу (с большим весом) присвоим значение $1$, а нижнему (с меньшим весом) - $0$:

\begin{table}[H]
    \centering
    \begin{tabular}{|c|c|c|c|c|}
        \hline
        C & C & C & EDFB & CA \textbf{[1]} \\
        A & A & A & C \textbf{[1]} & EDFB \textbf{[0]} \\
        E & E & E \textbf{[1]}   & A \textbf{[0]} & \\
        B & DF \textbf{[1]} & DFB \textbf{[0]} & & \\
        D \textbf{[1]} & B \textbf{[0]} & & & \\
        F \textbf{[0]} & & & & \\
        \hline
    \end{tabular}
\end{table}

% \begin{table}[H]
% \begin{tabular}{|r|c|c|c|c|c|c|}
% \hline
% \textbf{Символ} & C & A & E & B & D \textbf{[1]} & F \textbf{[0]} \\ \hline
% \textbf{Вероятность, $p$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$ & $\sfrac{3}{14}$ & $\sfrac{1}{14}$ & $\sfrac{1}{14}$ & $\sfrac{1}{14}$ \\ \hline\hline

% \textbf{Символ} & C & A & E & \multicolumn{2}{c|}{DF \textbf{[1]}} & B \textbf{[0]} \\ \hline
% \textbf{Вероятность, $p$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$ & $\sfrac{3}{14}$  & \multicolumn{2}{c|}{$\sfrac{2}{14}$} & $\sfrac{1}{14}$ \\ \hline\hline

% \textbf{Символ} & C & A & E \textbf{[1]} & \multicolumn{3}{c|}{DFB \textbf{[0]}} \\ \hline
% \textbf{Вероятность, $p$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$ & $\sfrac{3}{14}$  & \multicolumn{3}{c|}{$\sfrac{3}{14}$} \\ \hline\hline

% \textbf{Символ} & \multicolumn{4}{c|}{EDFB} & C \textbf{[1]} & A \textbf{[0]} \\ \hline
% \textbf{Вероятность, $p$} & \multicolumn{4}{c|}{$\sfrac{6}{14}$} & $\sfrac{5}{14}$ & $\sfrac{3}{14}$  \\ \hline\hline

% \textbf{Символ} & \multicolumn{2}{c|}{CA \textbf{[1]}} & \multicolumn{4}{c|}{EDFB \textbf{[0]}} \\ \hline
% \textbf{Вероятность, $p$} & \multicolumn{2}{c|}{$\sfrac{8}{14}$} & \multicolumn{4}{c|}{$\sfrac{6}{14}$} \\ \hline
% \end{tabular}
% \end{table}

\noindentПостроим кодовое дерево:
\begin{table}[H]
    \centering
    \begin{tabular}{cccccc}
    \multicolumn{6}{c}{CAEDFB ($\sfrac{5}{14} + \sfrac{3}{14} + \sfrac{3}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14}$)} \\
    \multicolumn{2}{c}{\textbf{[1]} $\swarrow$} & \multicolumn{4}{c}{$\searrow$ \textbf{[0]}} \\
    \multicolumn{2}{c}{CA ($\sfrac{5}{14} + \sfrac{3}{14}$)} & \multicolumn{4}{c}{EDFB ($\sfrac{3}{14} + \sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14}$)} \\
    \textbf{[1]} $\swarrow$ & $\searrow$ \textbf{[0]} & \textbf{[1]} $\swarrow$ & \multicolumn{3}{c}{$\searrow$ \textbf{[0]}} \\
    C ($\sfrac{5}{14}$) & A ($\sfrac{3}{14}$) & E $(\sfrac{3}{14})$ & \multicolumn{3}{c}{DFB ($\sfrac{1}{14} + \sfrac{1}{14} + \sfrac{1}{14}$)} \\
    & & & \multicolumn{2}{c}{\textbf{[1]} $\swarrow$} & $\searrow$ \textbf{[0]} \\
    & & & \multicolumn{2}{c}{DF ($\sfrac{1}{14} + \sfrac{1}{14}$)} & B ($\sfrac{1}{14}$) \\
    & & & \textbf{[1]} $\swarrow$ & $\searrow$ \textbf{[0]} & \\
    & & & D $(\sfrac{1}{14})$ & F $(\sfrac{1}{14})$ & \\
    \end{tabular}
\end{table}

\noindentПолучим следующую таблицу для кодировки:

\begin{table}[H]
    \centering
    \begin{tabularx}{0.7\linewidth}{|r|C|C|C|C|C|C|}
        \hline
        \textbf{Символ} & A  & B & C & D & E & F \\ \hline
        \textbf{Код}    & 10 & 000 & 11 & 0011 & 01 & 0010 \\ \hline
    \end{tabularx}
\end{table}

\noindentИсходная последовательность AAABCCCCCDEEEF кодируется следующей: $10.10.10.000.11.11.11.11.11.0011.01.01.01.0010$ - 33 бита.

Средняя длина кодового слова:
\[
    2 \times \frac{5}{14} + 2 \times \frac{3}{14} + 2 \times \frac{3}{14} + 3 \times \frac{1}{14} + 4 \times \frac{1}{14} + 4 \times \frac{1}{14} = \frac{33}{14} \approx 2,35
\]

Классический алгоритм Хаффмана имеет один существенный недостаток. Для восстановления содержимого сжатого текста при декодировании необходимо знать таблицу частот, которую использовали при кодировании. Следовательно, длина сжатого текста увеличивается на длину таблицы частот, которая должна посылаться впереди данных, что может свести на нет все усилия по сжатию данных. Кроме того, необходимость наличия полной частотной статистики перед началом собственно кодирования требует двух проходов по тексту: одного для построения модели текста (таблицы частот и дерева Хаффмана), другого для собственно кодирования.
